<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles del Curso | Learning UT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <img src="/Logo.jpg" alt="Logo LU" class="h-10 w-auto rounded-full">
                    <span class="ml-3 text-xl font-bold text-gray-800">Learning UT</span>
                </div>
                <div class="flex items-center gap-4">
                    <span id="userName" class="text-gray-700 font-medium"></span>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                        Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <button onclick="goBack()" class="mb-6 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg text-sm font-medium transition">
            ← Regresar a mi Dashboard
        </button>

        <div id="courseHeader" class="bg-white rounded-lg shadow p-6 mb-6">
            <h1 id="courseTitle" class="text-3xl font-bold text-gray-900 mb-2">Cargando...</h1>
            <p id="courseDescription" class="text-gray-600 mb-4">Cargando descripción...</p>
            
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Estudiantes Inscritos</p>
                    <p id="totalEnrolled" class="text-2xl font-bold text-blue-600">-</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Aprobados</p>
                    <p id="totalPassed" class="text-2xl font-bold text-green-600">-</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Promedio de Calificación</p>
                    <p id="averageScore" class="text-2xl font-bold text-purple-600">-</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Nivel</p>
                    <p id="courseLevel" class="text-2xl font-bold text-orange-600">-</p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Alumnos Inscritos</h2>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estudiante</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Email</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID Empleado</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Fecha de Inscripción</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Progreso</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Calificación</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="studentsList">
                        <tr>
                            <td colspan="7" class="px-4 py-4 text-center text-gray-500">Cargando estudiantes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // Check authentication
        const token = localStorage.getItem('token');
        const userRole = localStorage.getItem('userRole');
        
        if (!token || (userRole !== 'instructor' && userRole !== 'admin')) {
            window.location.href = '/login';
        }

        document.getElementById('userName').textContent = localStorage.getItem('userName') || 'Usuario';

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            localStorage.clear();
            window.location.href = '/login';
        });

        // Get course ID from URL
        const courseId = new URLSearchParams(window.location.search).get('id') || new URLSearchParams(window.location.search).get('courseId');

        if (!courseId) {
            alert('ID de curso no proporcionado');
            window.location.href = '/dashboard/instructor';
        }

        async function loadCourseDetail() {
            try {
                const response = await fetch(`/api/instructor/course/${courseId}/detail`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load course details');

                const data = await response.json();
                displayCourseHeader(data.course, data.stats);
                displayStudents(data.students);
            } catch (error) {
                console.error('[v0] Error loading course detail:', error);
                alert('Error al cargar los detalles del curso');
                window.location.href = '/dashboard/instructor';
            }
        }

        function displayCourseHeader(course, stats) {
            document.getElementById('courseTitle').textContent = course.title;
            document.getElementById('courseDescription').textContent = course.description || 'Sin descripción';
            document.getElementById('totalEnrolled').textContent = stats.totalEnrolled || 0;
            document.getElementById('totalPassed').textContent = stats.totalPassed || 0;
            document.getElementById('averageScore').textContent = `${stats.averageScore}%`;
            
            const levelMap = { 'beginner': 'Principiante', 'intermediate': 'Intermedio', 'advanced': 'Avanzado' };
            document.getElementById('courseLevel').textContent = levelMap[course.level] || course.level;
        }

        function displayStudents(students) {
            const tbody = document.getElementById('studentsList');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-4 text-center text-gray-500">No hay estudiantes inscritos en este curso.</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(student => {
                const enrollDate = new Date(student.enrolled_at).toLocaleDateString('es-ES');
                const statusBadge = student.passed 
                    ? '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Aprobado</span>'
                    : '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800">En Curso</span>';
                const scoreDisplay = student.score ? `${student.score.toFixed(1)}%` : 'N/A';

                return `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm text-gray-900 font-medium">${student.first_name} ${student.last_name}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${student.email}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${student.employee_id}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${enrollDate}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${student.progress || 0}%</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${scoreDisplay}</td>
                        <td class="px-4 py-3 text-sm">${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        window.goBack = function() {
            window.location.href = '/dashboard/instructor';
        };

        loadCourseDetail();
    </script>
    <script src="js/authState.js"></script>
</body>
</html>
